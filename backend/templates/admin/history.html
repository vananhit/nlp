{% extends "admin/layout.html" %}

{% block title %}Lịch sử Sử dụng{% endblock %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4">Lịch sử Sử dụng</h1>

    <!-- Filter Form -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary"><i class="fa-solid fa-filter me-2"></i>Bộ lọc</h6>
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('view_history') }}">
                <div class="row align-items-end g-3">
                    <div class="col-md-4">
                        <label for="email" class="form-label">Email người dùng</label>
                        <input type="text" class="form-control" id="email" name="email" value="{{ filters.email or '' }}" placeholder="Nhập email...">
                    </div>
                    <div class="col-md-3">
                        <label for="start_date" class="form-label">Từ ngày</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ filters.start_date or '' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="end_date" class="form-label">Đến ngày</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ filters.end_date or '' }}">
                    </div>
                    <div class="col-md-2 d-flex">
                        <button type="submit" class="btn btn-primary w-100 me-2">Lọc</button>
                        <a href="{{ url_for('view_history') }}" class="btn btn-outline-secondary w-100">Xóa</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary"><i class="fa-solid fa-list me-2"></i>Kết quả</h6>
        </div>
        <div class="card-body">
            <table id="historyTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Thời gian</th>
                        <th>Public IP</th>
                        <th>Trình duyệt</th>
                        <th>Hệ điều hành</th>
                        <th>User Agent</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.id }}</td>
                        <td>{{ log.user_email }}</td>
                        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>{{ log.public_ip }}</td>
                        <td>{{ log.browser }} {{ log.browser_version }}</td>
                        <td>{{ log.os }} {{ log.os_version }}</td>
                        <td>{{ log.user_agent }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function() {
    // --- Initialize DataTables ---
    $('#historyTable').DataTable({
        "order": [[ 2, "desc" ]],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json"
        }
    });

    // --- Set Default Date Filters ---
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    // Only set default dates if the fields are empty (i.e., no filter is currently applied)
    if (!startDateInput.value && !endDateInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();

        // First day of the current month
        const firstDay = new Date(year, month, 1);
        // Last day of the current month
        const lastDay = new Date(year, month + 1, 0);

        // Format date to YYYY-MM-DD for the input field
        const formatDate = (date) => {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) 
                month = '0' + month;
            if (day.length < 2) 
                day = '0' + day;

            return [year, month, day].join('-');
        }

        startDateInput.value = formatDate(firstDay);
        endDateInput.value = formatDate(lastDay);
    }
});
</script>
{% endblock %}
